<!-- adapted from: https://traineq.org/imgui_bundle_online/projects/min_bundle_pyodide_app/demo_heart.source.txt -->
<!doctype html>
<html>
<head>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; }
        #canvas { display: block; width: 100%; height: 100%;}
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
</head>
<body>
<canvas id="canvas" tabindex="0"></canvas>
<script type="text/javascript">
    // ====================== Start of Python code ============================
    pythonCode = `
import rendercanvas
print("rendercanvas version:", rendercanvas.__version__)
import numpy as np
from pyodide.ffi import run_sync
from js import document, ImageData, Uint8ClampedArray, window

# TODO: make this a proper RenderCanvas, just a poc for now
class HTMLBitmapCanvas():  
    def __init__(self):
        canvas_element = document.getElementById("canvas")
        self.canvas_element = canvas_element
        self.context = canvas_element.getContext("bitmaprenderer")
    
    def _rc_get_present_methods(self):
        return ["set_bitmap"]

    def _rc_get_logical_size(self):
        return self.canvas_element.width, self.canvas_element.height

    def set_bitmap(self, bitmap):
        h, w, _ = bitmap.shape
        flat_bitmap = bitmap.flatten()
        js_array = Uint8ClampedArray.new(flat_bitmap.tolist())
        image_data = ImageData.new(js_array, w, h)
        image_bitmap = run_sync(window.createImageBitmap(image_data))
        self.context.transferFromImageBitmap(image_bitmap)


canvas = HTMLBitmapCanvas()
shape = (*canvas._rc_get_logical_size(), 4)
bitmap = np.random.uniform(0, 255, shape).astype(np.uint8)
canvas.set_bitmap(bitmap)
`
    // ====================== End of Python code ==============================


    async function main(){
        // Load Pyodide
        let pyodide = await loadPyodide();

        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install('numpy');
        await micropip.install('rendercanvas');

        // Run the Python code
        pyodide.runPythonAsync(pythonCode);
    }
    main();
</script>
</body>
</html>